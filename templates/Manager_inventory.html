{% extends "manager_base.html" %}

{% block title %}Inventory Report - Manager Dashboard{% endblock %}

{% block content %}
<div class="inventory-report-container">
    <h2>Inventory Report</h2>

    <div class="report-filters">
        <div class="filter-group">
            <label for="category-filter">Category</label>
            <select id="category-filter" class="report-filter-select">
                <option value="all">All Categories</option>
                <!-- Will be populated dynamically -->
            </select>
        </div>

        <div class="filter-group">
            <label for="stock-filter">Stock Status</label>
            <select id="stock-filter" class="report-filter-select">
                <option value="all">All Items</option>
                <option value="low">Low Stock (<10)</option>
                <option value="out">Out of Stock</option>
                <option value="sufficient">Sufficient Stock</option>
            </select>
        </div>

        <button id="generate-report" class="report-button">
            <i class="fas fa-file-export"></i> Generate Report
        </button>
    </div>

    <div class="report-results">
        <table id="inventory-report-table">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Current Stock</th>
                    <th>Price</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="report-body">
                <!-- Will be populated dynamically -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load categories
    fetch('/api/product-categories')
        .then(response => response.json())
        .then(categories => {
            const select = document.getElementById('category-filter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });
    
    // Generate report button handler
    document.getElementById('generate-report').addEventListener('click', generateReport);
    
    function generateReport() {
        const category = document.getElementById('category-filter').value;
        const stockStatus = document.getElementById('stock-filter').value;
        
        // Show loading state
        const tbody = document.getElementById('report-body');
        tbody.innerHTML = '<tr><td colspan="6"><i class="fas fa-spinner fa-spin"></i> Loading inventory data...</td></tr>';
        
        // Build query params
        const params = new URLSearchParams();
        if (category !== 'all') params.append('category', category);
        if (stockStatus !== 'all') params.append('stock', stockStatus);
        
        fetch(`/manager/inventory-report-data?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                renderReport(data);
            })
            .catch(error => {
                tbody.innerHTML = `<tr><td colspan="6">Error loading report: ${error.message}</td></tr>`;
            });
    }
    
    function renderReport(products) {
        const tbody = document.getElementById('report-body');
        tbody.innerHTML = '';
        
        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No products match the selected criteria</td></tr>';
            return;
        }
        
        products.forEach(product => {
            const row = document.createElement('tr');
            
            // Determine stock status
            let status = '';
            let statusClass = '';
            if (product.StockQuantity <= 0) {
                status = 'Out of Stock';
                statusClass = 'status-out';
            } else if (product.StockQuantity < 10) {
                status = 'Low Stock';
                statusClass = 'status-low';
            } else {
                status = 'In Stock';
                statusClass = 'status-ok';
            }
            
            row.innerHTML = `
                <td>${product.ProductID}</td>
                <td>${product.ProductName}</td>
                <td>${product.Category}</td>
                <td>${product.StockQuantity}</td>
                <td>$${product.Price.toFixed(2)}</td>
                <td class="${statusClass}">${status}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // Load initial report
    generateReport();
});
</script>
{% endblock %}