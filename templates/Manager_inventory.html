{% extends "manager_base.html" %}

{% block title %}Inventory Report - Manager Dashboard{% endblock %}

{% block content %}
<div class="activity-logs-container">
    <h2>Inventory Activity Log</h2>
    <div class="log-filters">
        <select id="log-filter">
            <option value="all">All Activities</option>
            <option value="ADD_PRODUCT">Product Additions</option>
            <option value="UPDATE_STOCK">Stock Updates</option>
        </select>
        <button id="refresh-logs">Refresh</button>
        <span id="log-status"></span>
    </div>
    <div class="log-table-container">
        <table id="activity-logs-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody id="logs-body">
                <!-- Logs will be loaded here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load logs when page loads
    loadActivityLogs();

    // Set up refresh button
    const refreshBtn = document.getElementById('refresh-logs');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadActivityLogs);
    }

    // Logout modal handling
    setupLogoutModal();
});

async function loadActivityLogs() {
    try {
        const statusElement = document.getElementById('log-status');
        const tbody = document.getElementById('logs-body');

        if (statusElement) statusElement.textContent = 'Loading...';
        if (tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Loading logs...</td></tr>';

        const filter = document.getElementById('log-filter').value;
        const url = filter === 'all'
            ? '/manager/activity-logs'
            : `/manager/activity-logs?action=${filter}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const logs = await response.json();
        if (logs.error) throw new Error(logs.error);

        renderLogs(logs);
        if (statusElement) statusElement.textContent = '';
    } catch (error) {
        console.error('Error loading logs:', error);
        handleError(error, 'logs-body');
    }
}

function renderLogs(logs) {
    const tbody = document.getElementById('logs-body');
    if (!tbody) return;

    tbody.innerHTML = '';
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No activity logs found</td></tr>';
        return;
    }

    logs.forEach(log => {
        const row = document.createElement('tr');
        const timestamp = new Date(log.Timestamp).toLocaleString();
        row.innerHTML = `
            <td>${timestamp}</td>
            <td>${log.UserName || 'System'}</td>
            <td>${formatActionType(log.ActionType)}</td>
            <td>${log.Description || 'No description'}</td>
        `;
        tbody.appendChild(row);
    });
}

function formatActionType(action) {
    const actions = {
        'ADD_PRODUCT': 'Add Product',
        'UPDATE_STOCK': 'Update Stock'
    };
    return actions[action] || action;
}

function handleError(error, elementId) {
    console.error('Error:', error);
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Failed to load data. ${error.message}</p>
                <button class="retry-button">Retry</button>
            </div>
        `;
        document.querySelector('.retry-button')?.addEventListener('click', () => {
            if (elementId === 'logs-body') loadActivityLogs();
        });
    }
}

function setupLogoutModal() {
    const logoutBtn = document.querySelector('.logout a');
    const logoutModal = document.getElementById('logoutModal');
    const cancelLogout = document.getElementById('cancelLogout');

    if (logoutBtn && logoutModal && cancelLogout) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logoutModal.style.display = 'flex';
        });

        cancelLogout.addEventListener('click', () => {
            logoutModal.style.display = 'none';
        });
    }
}
</script>
{% endblock %}