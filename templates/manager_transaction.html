{% extends "manager_base.html" %}

{% block title %}New Transaction{% endblock %}

{% block content %}
<div class="header">
    <h1>New Transaction</h1>
</div>

<div class="transaction-container">
    <!-- Transaction interface will go here -->
    <div id="transaction-app">
        <div class="product-search">
            <input type="text" placeholder="Search products..." v-model="searchQuery" @input="searchProducts">
            <div class="search-results" v-if="searchResults.length > 0">
                <div class="product-item" v-for="product in searchResults" @click="addToCart(product)">
                    <span>${ product.ProductName }</span>
                    <span>$${ product.Price }</span>
                </div>
            </div>
        </div>
        
        <div class="cart-section">
            <h3>Current Transaction</h3>
            <div class="cart-items">
                <div class="cart-item" v-for="(item, index) in cart" :key="index">
                    <span>${ item.ProductName }</span>
                    <span>$${ item.Price } x ${ item.quantity }</span>
                    <button @click="removeFromCart(index)">Remove</button>
                </div>
            </div>
            
            <div class="cart-total">
                <h4>Total: $${ totalAmount }</h4>
            </div>
            
            <button class="complete-btn" @click="completeTransaction">Complete Transaction</button>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const { createApp, ref, computed } = Vue;
    
    createApp({
        setup() {
            const searchQuery = ref('');
            const searchResults = ref([]);
            const cart = ref([]);
            
            const totalAmount = computed(() => {
                return cart.value.reduce((sum, item) => sum + (item.Price * item.quantity), 0).toFixed(2);
            });
            
            function searchProducts() {
                if (searchQuery.value.length < 2) {
                    searchResults.value = [];
                    return;
                }
                
                fetch(`/api/products?q=${searchQuery.value}`)
                    .then(response => response.json())
                    .then(data => {
                        searchResults.value = data;
                    });
            }
            
            function addToCart(product) {
                const existingItem = cart.value.find(item => item.ProductID === product.ProductID);
                
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.value.push({
                        ...product,
                        quantity: 1
                    });
                }
                
                searchQuery.value = '';
                searchResults.value = [];
            }
            
            function removeFromCart(index) {
                cart.value.splice(index, 1);
            }
            
            function completeTransaction() {
                if (cart.value.length === 0) return;
                
                const transactionData = {
                    items: cart.value.map(item => ({
                        productId: item.ProductID,
                        quantity: item.quantity,
                        price: item.Price
                    })),
                    total: totalAmount.value
                };
                
                fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transactionData)
                })
                .then(response => response.json())
                .then(data => {
                    Swal.fire({
                        title: 'Transaction Complete',
                        text: `Transaction ID: ${data.transactionId}`,
                        icon: 'success'
                    });
                    cart.value = [];
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error',
                        text: 'Transaction failed',
                        icon: 'error'
                    });
                });
            }
            
            return {
                searchQuery,
                searchResults,
                cart,
                totalAmount,
                searchProducts,
                addToCart,
                removeFromCart,
                completeTransaction
            };
        }
    }).mount('#transaction-app');
});
</script>
{% endblock %}
{% endblock %}