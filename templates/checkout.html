<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cashier.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* POS-specific styles */
        .checkout-container {
            display: flex;
            height: calc(100vh - 80px);
            gap: 20px;
            padding: 20px;
        }

        /* Order Items Panel */
        .order-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            overflow-y: auto;
        }

        .order-panel h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .item-price {
            font-size: 0.9rem;
            color: #666;
        }

        .item-total {
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }

        /* Payment Method Panel */
        .payment-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
        }

        .payment-panel h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .payment-method.active {
            border-color: #1abc9c;
            background: rgba(26, 188, 156, 0.1);
        }

        .payment-method i {
            font-size: 1.2rem;
            color: #2a3f54;
        }

        .payment-details {
            display: none;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-top: 10px;
        }

        .payment-method.active .payment-details {
            display: block;
        }

        .payment-field {
            margin-bottom: 10px;
        }

        .payment-field label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #555;
        }

        .payment-field input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Calculator Panel */
        .calculator-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .amount-display {
            padding: 15px;
            background: #2a3f54;
            color: white;
        }

        .amount-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .amount-row.total {
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .calculator-display {
            padding: 15px;
            background: #2a3f54;
            color: white;
            text-align: right;
            font-size: 1.5rem;
            font-weight: 600;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #ddd;
            flex: 1;
        }

        .calc-btn {
            background: white;
            border: none;
            padding: 15px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .calc-btn:hover {
            background: #f0f0f0;
        }

        .calc-btn.operator {
            background: #f0f0f0;
            font-weight: 600;
        }

        .calc-btn.primary {
            background: #1abc9c;
            color: white;
        }

        .calc-btn.primary:hover {
            background: #16a085;
        }

        .calc-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .calc-btn.danger:hover {
            background: #c0392b;
        }

        .complete-btn {
            width: 100%;
            padding: 12px;
            background: #2a3f54;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }

        .complete-btn:hover {
            background: #3b4e63;
        }

        /* Empty Cart State */
        .empty-cart {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .empty-cart i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .checkout-container {
                flex-direction: column;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar (unchanged from your original) -->
    <div class="sidebar">
        <div class="logo">
            <h2>{{ cashier_name }}</h2>
        </div>
        <ul class="nav-menu">
            <li class="nav-item" onclick="window.location.href='{{ url_for('cashier.dashboard') }}'">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </li>
            <li class="nav-item active">
                <i class="fas fa-cash-register"></i>
                <span>Checkout</span>
            </li>
            <li class="nav-item" onclick="window.location.href='{{ url_for('cashier.transaction_history') }}'">
                <i class="fas fa-history"></i>
                <span>Transaction History</span>
            </li>
            <li class="nav-item logout" onclick="showLogoutModal()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </li>
        </ul>
    </div>

    <!-- Main Checkout Content -->
    <div class="main-content">
        <div class="checkout-container">
            <!-- Order Items Panel -->
            <div class="order-panel">
                <h2>Order Items</h2>
                <div id="orderItems">
                    <div class="empty-cart">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading order items...</p>
                    </div>
                </div>
            </div>

            <!-- Payment Method Panel -->
            <div class="payment-panel">
                <h2>Payment Method</h2>
                
                <div class="payment-method" data-method="cash" onclick="selectPaymentMethod(this)">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Cash</span>
                </div>
                <div class="payment-details">
                    <div class="payment-field">
                        <label>Amount Paid</label>
                        <input type="number" id="cashReceived" placeholder="0.00">
                    </div>
                    <div class="payment-field">
                        <label>Change</label>
                        <input type="text" id="cashChange" placeholder="0.00" readonly>
                    </div>
                </div>

                <div class="payment-method" data-method="e-wallet" onclick="selectPaymentMethod(this)">
                    <i class="fas fa-wallet"></i>
                    <span>E-Wallet</span>
                </div>
                <div class="payment-details">
                    <div style="text-align: center;">
                        <img src="{{ url_for('static', filename='images/tng_qr.png') }}" alt="E-Wallet QR Code" style="max-width: 200px; height: auto;">
                        <p style="margin-top: 10px; font-size: 0.9rem;">Scan the QR code to pay</p>
                    </div>
                </div>

                <div class="payment-method" data-method="card" onclick="selectPaymentMethod(this)">
                    <i class="fas fa-credit-card"></i>
                    <span>Debit/Credit Card</span>
                </div>
                <div class="payment-details">
                    <div class="payment-field">
                        <label>Card Number</label>
                        <input type="text" placeholder="1234 5678 9012 3456">
                    </div>
                    <div class="payment-field">
                        <label>Expiry Date</label>
                        <input type="text" placeholder="MM/YY">
                    </div>
                    <div class="payment-field">
                        <label>CVV</label>
                        <input type="text" placeholder="123">
                    </div>
                </div>

                <button class="complete-btn" onclick="completeTransaction()">
                    <i class="fas fa-check-circle"></i> Complete Payment
                </button>
            </div>

            <!-- Calculator Panel -->
            <div class="calculator-panel">
                <div class="amount-display">
                    <div class="amount-row">
                        <span>Total:</span>
                        <span id="displayTotal">RM0.00</span>
                    </div>
                    <div class="amount-row" id="paidRow" style="display: none;">
                        <span>Paid:</span>
                        <span id="displayPaid">RM0.00</span>
                    </div>
                    <div class="amount-row" id="changeRow" style="display: none;">
                        <span>Change:</span>
                        <span id="displayChange">RM0.00</span>
                    </div>
                    <div class="amount-row total">
                        <span>Amount Due:</span>
                        <span id="displayDue">RM0.00</span>
                    </div>
                </div>
                
                <div class="calculator-display" id="calcDisplay">0</div>
                <div class="calculator-buttons">
                    <button class="calc-btn" onclick="calcInput('7')">7</button>
                    <button class="calc-btn" onclick="calcInput('8')">8</button>
                    <button class="calc-btn" onclick="calcInput('9')">9</button>
                    <button class="calc-btn operator" onclick="calcInput('/')">/</button>
                    <button class="calc-btn" onclick="calcInput('4')">4</button>
                    <button class="calc-btn" onclick="calcInput('5')">5</button>
                    <button class="calc-btn" onclick="calcInput('6')">6</button>
                    <button class="calc-btn operator" onclick="calcInput('*')">×</button>
                    <button class="calc-btn" onclick="calcInput('1')">1</button>
                    <button class="calc-btn" onclick="calcInput('2')">2</button>
                    <button class="calc-btn" onclick="calcInput('3')">3</button>
                    <button class="calc-btn operator" onclick="calcInput('-')">-</button>
                    <button class="calc-btn" onclick="calcInput('0')">0</button>
                    <button class="calc-btn" onclick="calcInput('.')">.</button>
                    <button class="calc-btn primary" onclick="calcEquals()">=</button>
                    <button class="calc-btn operator" onclick="calcInput('+')">+</button>
                    <button class="calc-btn" onclick="calcClear()">C</button>
                    <button class="calc-btn" onclick="calcBackspace()">⌫</button>
                    <button class="calc-btn primary" onclick="applyToPayment()">Apply</button>
                    <button class="calc-btn danger" onclick="clearCalculator()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>Transaction Successful!</h3>
            <p id="transaction-details">
                Transaction ID: <span id="transactionId"></span><br>
                Total Amount: <span id="transactionAmount"></span>
            </p>
            <div class="modal-buttons">
                <button class="action-button primary" onclick="window.location.href='{{ url_for('cashier.new_transaction') }}'">
                    New Transaction
                </button>
                <button class="action-button" onclick="window.location.href='{{ url_for('cashier.dashboard') }}'">
                    Back to Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
            <iframe id="receiptFrame" style="flex: 1; width: 100%; border: none;"></iframe>
            <div style="display: flex; gap: 10px; padding: 15px;">
                <button class="action-button" style="flex: 1;" onclick="printReceipt()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="action-button primary" style="flex: 1;" onclick="closeReceiptModal()">
                    <i class="fas fa-check"></i> Done
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
        let currentCalcValue = '0';
        let selectedPaymentMethod = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            renderOrderItems();
            updateTotals();
            
            // Set up event listeners
            document.getElementById('cashReceived').addEventListener('input', calculateChange);
        });

        // Render order items
        function renderOrderItems() {
            const orderItems = document.getElementById('orderItems');
            
            if (cart.length === 0) {
                orderItems.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>No items in order</p>
                    </div>
                `;
                return;
            }

            orderItems.innerHTML = '';
            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">RM${item.price.toFixed(2)} × ${item.quantity}</div>
                    </div>
                    <div class="item-total">RM${(item.price * item.quantity).toFixed(2)}</div>
                `;
                orderItems.appendChild(cartItem);
            });
        }

        // Update order totals
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.06;
            const total = subtotal + tax;
            
            // Update display
            document.getElementById('displayTotal').textContent = `RM${total.toFixed(2)}`;
            document.getElementById('displayDue').textContent = `RM${total.toFixed(2)}`;
            
            // Update calculator display with total
            currentCalcValue = total.toString();
            updateCalcDisplay();
            
            // If cash is selected, update payment fields
            if (selectedPaymentMethod === 'cash') {
                document.getElementById('cashReceived').value = total.toFixed(2);
                calculateChange();
            }
        }

        // Select payment method
        function selectPaymentMethod(element) {
            document.querySelectorAll('.payment-method').forEach(method => {
                method.classList.remove('active');
            });
            
            element.classList.add('active');
            selectedPaymentMethod = element.dataset.method;
            
            // Show/hide paid and change rows
            const paidRow = document.getElementById('paidRow');
            const changeRow = document.getElementById('changeRow');
            
            if (selectedPaymentMethod === 'cash') {
                paidRow.style.display = 'flex';
                changeRow.style.display = 'flex';
                
                const total = parseFloat(document.getElementById('displayTotal').textContent.replace('RM', ''));
                document.getElementById('cashReceived').value = total.toFixed(2);
                calculateChange();
            } else {
                paidRow.style.display = 'none';
                changeRow.style.display = 'none';
            }
        }

        // Calculate change for cash payment
        function calculateChange() {
            if (selectedPaymentMethod !== 'cash') return;
            
            const total = parseFloat(document.getElementById('displayTotal').textContent.replace('RM', ''));
            const received = parseFloat(document.getElementById('cashReceived').value) || 0;
            const change = received - total;
            
            document.getElementById('cashChange').value = change >= 0 ? change.toFixed(2) : '0.00';
            document.getElementById('displayPaid').textContent = `RM${received.toFixed(2)}`;
            document.getElementById('displayChange').textContent = `RM${change >= 0 ? change.toFixed(2) : '0.00'}`;
            document.getElementById('displayDue').textContent = `RM${Math.max(0, total - received).toFixed(2)}`;
        }

        // Complete the transaction
        function completeTransaction() {
            if (cart.length === 0) {
                alert('No items in the order');
                return;
            }
            
            if (!selectedPaymentMethod) {
                alert('Please select a payment method');
                return;
            }
            
            // Validate cash payment
            if (selectedPaymentMethod === 'cash') {
                const total = parseFloat(document.getElementById('displayTotal').textContent.replace('RM', ''));
                const received = parseFloat(document.getElementById('cashReceived').value) || 0;
                
                if (received < total) {
                    alert('Amount received is less than total amount');
                    return;
                }
            }
            
            const transactionData = {
                cashierId: getCashierId(),
                totalAmount: parseFloat(document.getElementById('displayTotal').textContent.replace('RM', '')),
                paymentMethod: selectedPaymentMethod,
                items: cart.map(item => ({
                    productId: item.id,
                    quantity: item.quantity,
                    price: item.price
                }))
            };
            
            // Send transaction to server
            fetch('/cashier/complete-transaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(transactionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show receipt
                    showReceiptModal(data.receiptPdf);
                    
                    // Update success modal
                    document.getElementById('transactionId').textContent = data.transactionId;
                    document.getElementById('transactionAmount').textContent = `RM${data.totalAmount.toFixed(2)}`;
                    
                    // Clear cart
                    cart = [];
                    sessionStorage.removeItem('cart');
                } else {
                    alert(data.error || 'Failed to process transaction');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to process transaction');
            });
        }

        // Calculator functions
        function calcInput(value) {
            if (currentCalcValue === '0' && value !== '.') {
                currentCalcValue = value;
            } else {
                currentCalcValue += value;
            }
            updateCalcDisplay();
        }

        function calcClear() {
            currentCalcValue = '0';
            updateCalcDisplay();
        }

        function clearCalculator() {
            currentCalcValue = '0';
            updateCalcDisplay();
            
            if (selectedPaymentMethod === 'cash') {
                document.getElementById('cashReceived').value = '';
                document.getElementById('cashChange').value = '0.00';
                document.getElementById('displayPaid').textContent = 'RM0.00';
                document.getElementById('displayChange').textContent = 'RM0.00';
                const total = parseFloat(document.getElementById('displayTotal').textContent.replace('RM', ''));
                document.getElementById('displayDue').textContent = `RM${total.toFixed(2)}`;
            }
        }

        function calcBackspace() {
            if (currentCalcValue.length === 1) {
                currentCalcValue = '0';
            } else {
                currentCalcValue = currentCalcValue.slice(0, -1);
            }
            updateCalcDisplay();
        }

        function calcEquals() {
            try {
                // Replace × with * for evaluation
                currentCalcValue = eval(currentCalcValue.replace('×', '*')).toString();
                updateCalcDisplay();
            } catch (e) {
                currentCalcValue = 'Error';
                updateCalcDisplay();
                setTimeout(calcClear, 1000);
            }
        }

        function updateCalcDisplay() {
            document.getElementById('calcDisplay').textContent = currentCalcValue;
        }

        function applyToPayment() {
            if (selectedPaymentMethod === 'cash') {
                document.getElementById('cashReceived').value = currentCalcValue;
                calculateChange();
            }
        }

        // Show receipt modal
        function showReceiptModal(pdfBase64) {
            const modal = document.getElementById('receiptModal');
            const frame = document.getElementById('receiptFrame');
            
            const pdfBlob = base64ToBlob(pdfBase64, 'application/pdf');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            frame.src = pdfUrl;
            
            modal.style.display = 'flex';
        }

        function closeReceiptModal() {
            const modal = document.getElementById('receiptModal');
            const frame = document.getElementById('receiptFrame');
            
            if (frame.src) {
                URL.revokeObjectURL(frame.src);
                frame.src = '';
            }
            
            modal.style.display = 'none';
            document.getElementById('successModal').style.display = 'flex';
        }

        function printReceipt() {
            const frame = document.getElementById('receiptFrame');
            frame.contentWindow.focus();
            frame.contentWindow.print();
        }

        function base64ToBlob(base64, contentType) {
            contentType = contentType || '';
            const sliceSize = 1024;
            const byteCharacters = atob(base64);
            const byteArrays = [];
            
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            
            return new Blob(byteArrays, {type: contentType});
        }

        // Get cashier ID (you'll need to implement this based on your auth system)
        function getCashierId() {
            // This should return the logged-in cashier's ID
            return 1; // Replace with actual implementation
        }

        function showLogoutModal() {
            document.getElementById('logoutModal').style.display = 'flex';
        }
    </script>
</body>
</html>